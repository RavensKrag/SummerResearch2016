# encoding: utf-8

# gems
require 'rubygems'

require 'rake'
require 'rake/clean'

require 'bundler/setup'
require 'require_all'

# constants
PATH_TO_FILE = File.expand_path(File.dirname(__FILE__))

# -- file hierarchy --
		# ROOT
		# 	this directory
		# 		this file

# Must expand '..' shortcut into a proper path. But that results in a shorter string.
PATH_TO_ROOT = File.expand_path '../..', __FILE__






task :load_dependencies do
	# gems
	require 'open-uri'
	require 'nokogiri'
	require 'yaml'
	require 'csv'
	
	# files
	Dir.chdir PATH_TO_ROOT do
		require_all './lib/SummerResearch'
	end
end

task :load_main do
	require './main'
end


task :default => :run

# run the program
task :run => [:setup] do
	p @env
	# consider different forms of caching
	# -- instance variable: cache for the session
	# -- save to disk: cache for multiple sessions
	
	# TODO: consider promoting pathway4 as the default?
end

# all root tasks should list this as a dependency
task :setup => [:load_dependencies, :load_main] do
	puts "=== setup environment"
	@env = SummerResearch::Main.new
end

task :all => [
	:pathway1,
	:pathway2,
	:pathway3,
	:pathway4,
	:pathway5,
	:pathway6,
	:pathway7
]





# 1
task :pathwayA => :setup do
	puts "=== setup data"
	# search for relevant programs of study
	# (required to run #foo2)
	@env.foo1 [
		"Computer Science",
		"Information Technology",
		"Electrical Engineering",
		"Biology",
		"Psychology"
	]
end

# 5
task :pathwayB => :setup do
	# search catalog for even more data?
	deparments = ["CS", "BIOL", "CHEM", "PSYC"]
	@env.foo5(deparments)
end



# 1 2 3
task :pathway1 => :pathwayA do
	courses = @env.foo2("Computer Science, BS")
	
	@env.foo3()
end

# 5 4
task :pathway2 => :setup do
	@env.foo5(["CS"])	
	@env.foo4()
end

# 1 6
task :pathway3 => :pathwayA do
	@env.foo6() # NOTE: foo6 not yet properly ported
end

# 1 5 7 8 10 9
task :pathway4 => [:pathwayA, :pathwayB] do
	# TODO: cache 1 and 5 to speed up evaluation
	
	
	
	puts "=== run processing"
	
	[
		"Computer Science, BS",
		"Applied Computer Science, BS",
		"Biology, BA",
		"Biology, BS",
		"Psychology, BA"
	]
	
	# take one degree program, and walk the dependencies for all courses in the degree
	course_list = @env.foo7("Computer Science, BS")  # get all relevant courses
	class_dependencies = @env.foo8(course_list)      # construct all dependencies
	
	output_filepath = ""
	@env.foo10(class_dependencies, output_filepath)  # visualize the dependency graph
	
	
	# query: what is the chain of courses that lead up to this course? 
	@env.foo9(class_dependencies, "CS 465")
	# => [CS 367, ECE 301, CS 262, CS 211, CS 112, MATH 113, CS 101?]
	
	# TODO: This is actually not properly a list, it is a subgraph. Some dependencies do not lie along the main path. How do you display that information?
	# NOTE: "ECE 301" is the old name, IIRC
end

# 1 2 13
task :pathway5 => :pathwayA do
	courses = @env.foo2("Computer Science, BS")
	
	
	puts "=== run processing"
	course_data = @env.foo13(courses)
end

# test course parsing with a couple of key examples
# (TODO: take extra data from foo3 and move into foo12 for more variety of data)
# 1 2 12 13
task :pathway6 => :pathwayA do
	courses = @env.foo2("Computer Science, BS")
	
	
	puts "=== run processing"
	
	courses = @env.foo12()
	course_data = @env.foo13(courses)
end

# test all courses across various majors to make sure everything runs correctly
# uses foo11 to detect which courses have odd link formats
# 1 2 11
task :pathway7 => :pathwayA do	
	puts "=== cycle through programs of study..."
	
	programs = [
		"Computer Science, BS",
		"Applied Computer Science, BS",
		"Biology, BA",
		"Biology, BS",
		"Psychology, BA"
	]
	programs.each do |degree_name|
		puts "=== Getting info for: #{degree_name}"
		courses = @env.foo2(degree_name)
		# If the program list has a weird link in it, then the foo2 will fail before reaching the end of the list
			# url = @env.degrees[degree_name]
			# course_list = SummerResearch.degree_requirements(url)
			# puts "test"
		# failure occurs inside of SummerResearch.degree_requiremnts
		
		puts "=== analyzing courses... "
		course_data = @env.foo11(courses)
	end
	
	# NOTE: perhaps not all majors work right now? so be careful of that too
	
	
	
	# NOTE: the following programs of study only use Type A or Type B catalog links
		# "Computer Science, BS",
		# "Biology, BA",
	# NOTE: the following programs of study are known to list courses with Type C catalog links
		# "Applied Computer Science, BS",
		# "Biology, BS",
		# "Psychology, BA"
end





# this is just a template
# 1 2 3 (list the full foo execution chain?)
task :pathwayX => :setup do
	
end


